<!DOCTYPE html>
<!-- saved from url=(0094)http://www.jonathan-petitcolas.com/2015/07/27/importing-blender-modelized-mesh-in-threejs.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><script type="text/javascript" async="" src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/ga.js"></script><script>(function main() {
    // Create enabled event
    function fireEnabledEvent() {
        // If gli exists, then we are already present and shouldn't do anything
        if (!window.gli) {
            setTimeout(function () {
                var enabledEvent = document.createEvent("Event");
                enabledEvent.initEvent("WebGLEnabledEvent", true, true);
                document.dispatchEvent(enabledEvent);
            }, 0);
        } else {
            //console.log("WebGL Inspector already embedded on the page - disabling extension");
        }
    };

    // Grab the path root from the extension
    document.addEventListener("WebGLInspectorReadyEvent", function (e) {
        var pathElement = document.getElementById("__webglpathroot");
        if (window["gliloader"]) {
            gliloader.pathRoot = pathElement.innerText;
        } else {
            // TODO: more?
            window.gliCssUrl = pathElement.innerText + "gli.all.css";
        }
    }, false);

    // Rewrite getContext to snoop for webgl
    var originalGetContext = HTMLCanvasElement.prototype.getContext;
    if (!HTMLCanvasElement.prototype.getContextRaw) {
        HTMLCanvasElement.prototype.getContextRaw = originalGetContext;
    }
    HTMLCanvasElement.prototype.getContext = function () {
        var ignoreCanvas = this.internalInspectorSurface;
        if (ignoreCanvas) {
            return originalGetContext.apply(this, arguments);
        }

        var result = originalGetContext.apply(this, arguments);
        if (result == null) {
            return null;
        }

        var contextNames = ["moz-webgl", "webkit-3d", "experimental-webgl", "webgl", "3d"];
        var requestingWebGL = contextNames.indexOf(arguments[0]) != -1;
        if (requestingWebGL) {
            // Page is requesting a WebGL context!
            fireEnabledEvent(this);

            // If we are injected, inspect this context
            if (window.gli) {
                if (gli.host.inspectContext) {
                    // TODO: pull options from extension
                    result = gli.host.inspectContext(this, result);
                    // NOTE: execute in a timeout so that if the dom is not yet
                    // loaded this won't error out.
                    window.setTimeout(function() {
                        var hostUI = new gli.host.HostUI(result);
                        result.hostUI = hostUI; // just so we can access it later for debugging
                    }, 0);
                }
            }
        }

        return result;
    };
})();</script><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="http://www.jonathan-petitcolas.com/atom.xml" rel="alternate" title="Jonathan Petitcolas" type="application/atom+xml">
  <link href="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/style.css">
  <link rel="stylesheet" href="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/syntax.css">
  
  <!-- Google Analytics -->
  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2016151-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script>
  <!-- End of Google Analytics -->
 <script type="text/javascript" async="" src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/embed.js"></script></head>
 <body>
  <header>
    <div>
      <a href="http://www.jonathan-petitcolas.com/">
        <img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/jonathan-petitcolas.jpg" alt="Jonathan Petitcolas - Photo : © Lucille Caballero http://www.lucillecaballero.com" title="Jonathan Petitcolas - Photo : © Lucille Caballero http://www.lucillecaballero.com">
      </a>
      <h1><a href="http://www.jonathan-petitcolas.com/">Jonathan Petitcolas</a></h1>
      <h2>Symfony2 and Node.js enthusiast</h2>
      <nav>
        <p>
          <a href="http://www.jonathan-petitcolas.com/">Home</a> •
          <a href="http://www.jonathan-petitcolas.com/resume">Resume</a> •
          <a href="http://www.jonathan-petitcolas.com/archives">Archives</a>
        </p>
      </nav>
      <ul class="social-networks">
        <li>
          <a href="https://twitter.com/intent/user?screen_name=Sethpolma">
            <img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/twitter.png" alt="Follow me on Twitter: @Sethpolma" title="Follow me on Twitter: @Sethpolma">
          </a>
        </li>
        <li>
          <a href="https://plus.google.com/+JonathanPetitcolas">
            <img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/google-plus.png" alt="Follow me on Google+: +Jonathan.Petitcolas" title="Follow me on Google+: +Jonathan.Petitcolas">
          </a>
        </li>
        <li>
          <a href="https://github.com/jpetitcolas">
            <img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/github.png" alt="Follow me on GitHub: @jpetitcolas" title="Follow me on GitHub: @jpetitcolas">
          </a>
        </li>
      </ul>
    </div>
  </header>
  <div class="content"><article>
    <h1>Importing a Modeled Mesh From Blender to Three.js</h1>
    
    <p>It has been a very long time since the last <a href="http://www.jonathan-petitcolas.com/2013/04/02/create-rotating-cube-in-webgl-with-threejs.html">Three.js rotating cube post</a>.
Better late than never, right? Here is the next part about the import and animation
of a more complex mesh created in a modeling software. Yet, as we are not designer (and
a fortiori, not 3D designer), we will focus on a not too complicated mesh: the
<a href="http://www.marmelab.com/">marmelab</a> logo.</p>

<div class="image">
    <img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/marmelab-logo.png" alt="marmelab logo" title="marmelab logo" class="responsive">
</div>

<h2>Modeling Marmelab Logo with Blender</h2>

<p>We are going to use <a href="http://www.blender.org/">Blender</a>, a free and open-source 3D modeler.
First, let's create the mesh. Fortunately, marmelab logo is quite simple: it is
composed of five cubes glued together to form the letter M. Here is a video describing
this modeling:</p>

<div class="embed-container">
    <iframe src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/cxT63CxU-ag.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<h2>Export a Blender Mesh in JSON for Three.js</h2>

<p>Now that we got our mesh (you can download it <a href="https://github.com/jpetitcolas/webgl-experiments/raw/gh-pages/01-rotating-mesh/marmelab.blend">here</a>),
let's take a look on how to export it for Three.js. Three.js expects to get a Mesh in
JSON format. Fortunately, the community has already provided a <a href="https://github.com/mrdoob/three.js/tree/master/utils/exporters/blender">Blender to Three.js exporter</a>.
So, download it and put the <code>io_three</code> folder under your <code>~/.config/blender/2.69/scripts/addons/</code>
folder or its equivalent depending your operating system (check the README for more informations).</p>

<p>Then, open the <code>File &gt; User preferences</code> and go to the <code>Addons</code> tab.
Search for <code>Three.js</code> and enable the found plug-in. Now, you should be able to see
a <code>File &gt; Export &gt; Three.js</code> option. On the opened tab, ensure that <code>Face Materials</code>
checkbox is checked. Otherwise, you won't have materials, and Three.js is going to
refuse to import your mesh.</p>

<p>Once saved, your file should look like the following:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s2">"metadata"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"uvs"</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"Geometry"</span><span class="p">,</span>
        <span class="s2">"normals"</span><span class="o">:</span> <span class="mi">31</span><span class="p">,</span>
        <span class="s2">"generator"</span><span class="o">:</span> <span class="s2">"io_three"</span><span class="p">,</span>
        <span class="s2">"materials"</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">"version"</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">"vertices"</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">"faces"</span><span class="o">:</span> <span class="mi">198</span>
    <span class="p">},</span>
    <span class="s2">"vertices"</span><span class="o">:</span><span class="p">[</span><span class="cm">/* ... */</span><span class="p">],</span>
    <span class="s2">"uvs"</span><span class="o">:</span> <span class="p">[],</span>
    <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"CubeGeometry"</span><span class="p">,</span>
    <span class="s2">"materials"</span><span class="o">:</span> <span class="p">[</span><span class="cm">/* ... */</span><span class="p">],</span>
    <span class="s2">"normals"</span><span class="o">:</span><span class="p">[</span><span class="cm">/* ... */</span><span class="p">],</span>
    <span class="s2">"faces"</span><span class="o">:</span><span class="p">[</span><span class="cm">/* ... */</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>All required data is here. The most important are vertices, faces,
normals (to compute lighting correctly), and materials.</p>

<h2>Importing Mesh From Blender in Three.js</h2>

<p>Now we got our mesh into an understandable format, let's import it in Three.js.
Based on the <a href="http://www.jonathan-petitcolas.com/2013/04/02/create-rotating-cube-in-webgl-with-threejs.html">last tutorial</a>
code, we just have to replace our <code>initCube</code> function by an <code>initMesh</code> one:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">mesh</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">initMesh</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">JSONLoader</span><span class="p">();</span>
    <span class="nx">loader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">'./marmelab-logo.json'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">geometry</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="nx">geometry</span><span class="p">);</span>
        <span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">mesh</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that as you load a file dynamically, you can't open your file directly with
a browser. You have to use a Web server. On Linux, you can use for instance
the Node.js <code>http-server</code> package.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">npm install -g http-server
http-server .
</code></pre></div>
<h2>Rotating a Mesh</h2>

<p>Do not forget to modify the <code>rotateCube</code> function:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">rotateMesh</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mesh</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">mesh</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">SPEED</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">mesh</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">SPEED</span><span class="p">;</span>
    <span class="nx">mesh</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">z</span> <span class="o">-=</span> <span class="nx">SPEED</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>As you can see, working with a mesh is exactly the same as working with a primitive.
We just check that our mesh is loaded to avoid a warning. Indeed, the loading function
is an asynchronous one and then, the rendering loop may start before our model is in
memory. A cleaner way to deal with it would be to start rendering only when model is
loaded, but let's keep it simple for this tutorial.</p>

<p>If your refresh your browser, you should now see a wireframed rotating marmelab logo.
Yet, if you look deeper, you may see a graphical glitch:</p>

<p><img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/marmelab-logo-glitch.png" alt="Marmelab rotation logo&#39;s glitch" title="Marmelab rotation logo&#39;s glitch"></p>

<p>It seems some edges are broken. No mesh has been hurt during this animation, I swear.
It is just a concrete example of the <code>zFar</code> distance from this previous post schema:</p>

<p><img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/perspective-ecran.png" alt="Perspective camera in WebGL" title="Perspective camera in WebGL"></p>

<p>The value provided to the camera is not enough. So, we got two solutions: either
increase the camera maximum length vision, or reduce the size of our mesh. Let choose
the latter. Modify the <code>initMesh</code> method adding this line in the callback:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">mesh</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">;</span>
</code></pre></div>
<p>This way, we reduce the size of our rotation logo by 25%. The glitch should
have disappeared.</p>

<h3>Changing Rotation Center Position</h3>

<p>Rotation center is currently located at the bottom of one of the M branch. It would
be far better if it occurred at the common point of all cubes. To do so, we have
to translate the rotation origin, using transformation matrices. Sounds complicated?
Fortunately, Three.js simplifies a lot our work:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">loader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">'./marmelab-logo.json'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">geometry</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="nx">geometry</span><span class="p">);</span>
    <span class="nx">mesh</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">;</span>
    <span class="nx">mesh</span><span class="p">.</span><span class="nx">translation</span> <span class="o">=</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">GeometryUtils</span><span class="p">.</span><span class="nx">center</span><span class="p">(</span><span class="nx">geometry</span><span class="p">);</span>
    <span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">mesh</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>All the magic happens on the <code>mesh.translation</code> line. We retrieve the center of
our mesh, thanks to the <code>GeometryUtils.center</code>, and then translate it accordingly
to make it rotate on its center.</p>

<h2>Loading Materials</h2>

<p>Our Blender file contains several materials in order to colorize different faces.
So, let's add these materials to our mesh to get rid of this wireframe display.
Materials are also loaded through the <code>loader.load</code> method. You just have to
add a second argument <code>materials</code> to the callback function:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">loader</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">'./marmelab-logo.json'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">geometry</span><span class="p">,</span> <span class="nx">materials</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="nx">geometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshFaceMaterial</span><span class="p">(</span><span class="nx">materials</span><span class="p">));</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div>
<p>Do not forget to pass materials to the <code>THREE.MeshFaceMaterial</code> function, otherwise
you would get the following error:</p>

<blockquote>
<p>Cannot read property 'uniforms' of undefined</p>
</blockquote>

<h3>Let There Be Light</h3>

<p>We don't have wireframes anymore, but our textures are fully black. This is due
to a lack of light on our scene.</p>

<p><img src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/mesh-with-no-light.png" alt="Three.js mesh without lights" title="Three.js mesh without lights"></p>

<p>So, let's create a new <code>initLights</code> method and let's call it in our <code>init</code> function:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">initLights</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">light</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">AmbientLight</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">);</span>
    <span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">light</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>We added here a white <code>AmbientLight</code>. This kind of light is applied everywhere, so
you don't have to worry about the light position. As we are going to see lights in
more details in another post, I won't cover it for the moment.</p>

<div class="embed-container">
    <iframe src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/saved_resource.html"></iframe>
</div>

<p>Woohoo! We now have a nice looking marmelab logo. As usual, <a href="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/saved_resource.html">demonstration</a> and <a href="https://github.com/jpetitcolas/webgl-experiments/tree/gh-pages/01-rotating-mesh">source code</a> are
both available on GitHub.</p>

</article>


<div id="disqus_thread"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Importing a Modeled Mesh From Blender to Three.js - Jonathan Petitcolas_files/saved_resource(1).html" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 688px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonathanpetitcolas'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript>

</div>


</body></html>